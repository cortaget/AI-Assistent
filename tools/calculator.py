# tools/calculator.py
from tools.tool_manager import Tool
import re


def calculate(expression: str = None) -> str:
    """–ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä"""
    if not expression:
        return "–ù–µ —É–∫–∞–∑–∞–Ω–æ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è"

    try:
        safe_expr = re.sub(r'[^0-9+\-*/().\s]', '', expression)

        if not safe_expr or not any(c.isdigit() for c in safe_expr):
            return "–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –≤—ã—Ä–∞–∂–µ–Ω–∏–µ"

        result = eval(safe_expr)
        return f"{safe_expr} = {result}"

    except ZeroDivisionError:
        return "–û—à–∏–±–∫–∞: –¥–µ–ª–µ–Ω–∏–µ –Ω–∞ –Ω–æ–ª—å"
    except Exception as e:
        return f"–û—à–∏–±–∫–∞: {e}"


def extract_expression(user_input: str) -> dict:
    """
    –≠–ö–°–¢–†–ê–ö–¢–û–† —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π —Å–æ—Å—Ç–∞–≤–Ω—ã—Ö —á–∏—Å–µ–ª (—Å–æ—Ä–æ–∫ —Ç—Ä–∏ = 43)
    """
    import re

    expression = user_input.lower()

    # === –®–ê–ì 1: –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ—Å—Ç–∞–≤–Ω—ã—Ö —á–∏—Å–µ–ª (20-99) ===
    # "—Å–æ—Ä–æ–∫ —Ç—Ä–∏" ‚Üí "43", "–¥–≤–∞–¥—Ü–∞—Ç—å –ø—è—Ç—å" ‚Üí "25"

    # –î–µ—Å—è—Ç–∫–∏
    tens = {
        "–¥–≤–∞–¥—Ü–∞—Ç—å": 20, "—Ç—Ä–∏–¥—Ü–∞—Ç—å": 30, "—Å–æ—Ä–æ–∫": 40, "–ø—è—Ç—å–¥–µ—Å—è—Ç": 50,
        "—à–µ—Å—Ç—å–¥–µ—Å—è—Ç": 60, "—Å–µ–º—å–¥–µ—Å—è—Ç": 70, "–≤–æ—Å–µ–º—å–¥–µ—Å—è—Ç": 80, "–¥–µ–≤—è–Ω–æ—Å—Ç–æ": 90
    }

    # –ï–¥–∏–Ω–∏—Ü—ã (1-9)
    ones = {
        "–æ–¥–∏–Ω": 1, "–æ–¥–Ω–∞": 1, "–¥–≤–∞": 2, "–¥–≤–µ": 2, "—Ç—Ä–∏": 3, "—á–µ—Ç—ã—Ä–µ": 4,
        "–ø—è—Ç—å": 5, "—à–µ—Å—Ç—å": 6, "—Å–µ–º—å": 7, "–≤–æ—Å–µ–º—å": 8, "–¥–µ–≤—è—Ç—å": 9
    }

    # –ü–æ–ª–Ω—ã–µ —á–∏—Å–ª–∞ (10-19, 100+)
    full_numbers = {
        "–¥–µ—Å—è—Ç—å": 10, "–æ–¥–∏–Ω–Ω–∞–¥—Ü–∞—Ç—å": 11, "–¥–≤–µ–Ω–∞–¥—Ü–∞—Ç—å": 12, "—Ç—Ä–∏–Ω–∞–¥—Ü–∞—Ç—å": 13,
        "—á–µ—Ç—ã—Ä–Ω–∞–¥—Ü–∞—Ç—å": 14, "–ø—è—Ç–Ω–∞–¥—Ü–∞—Ç—å": 15, "—à–µ—Å—Ç–Ω–∞–¥—Ü–∞—Ç—å": 16,
        "—Å–µ–º–Ω–∞–¥—Ü–∞—Ç—å": 17, "–≤–æ—Å–µ–º–Ω–∞–¥—Ü–∞—Ç—å": 18, "–¥–µ–≤—è—Ç–Ω–∞–¥—Ü–∞—Ç—å": 19,
        "—Å—Ç–æ": 100, "–¥–≤–µ—Å—Ç–∏": 200, "—Ç—Ä–∏—Å—Ç–∞": 300, "–Ω–æ–ª—å": 0
    }

    # –ò—â–µ–º —Å–æ—Å—Ç–∞–≤–Ω—ã–µ —á–∏—Å–ª–∞: "—Å–æ—Ä–æ–∫ —Ç—Ä–∏" ‚Üí "43"
    for ten_word, ten_val in tens.items():
        for one_word, one_val in ones.items():
            compound = f"{ten_word} {one_word}"
            if compound in expression:
                expression = expression.replace(compound, str(ten_val + one_val))

    # –ó–∞–º–µ–Ω—è–µ–º –¥–µ—Å—è—Ç–∫–∏
    for word, num in tens.items():
        expression = expression.replace(word, str(num))

    # –ó–∞–º–µ–Ω—è–µ–º –µ–¥–∏–Ω–∏—Ü—ã –∏ –ø–æ–ª–Ω—ã–µ —á–∏—Å–ª–∞
    for word, num in {**ones, **full_numbers}.items():
        expression = expression.replace(word, str(num))

    # === –®–ê–ì 2: –û–ø–µ—Ä–∞—Ç–æ—Ä—ã ===
    replacements = {
        "–ø–ª—é—Å": "+",
        "–º–∏–Ω—É—Å": "-",
        "—É–º–Ω–æ–∂–∏—Ç—å": "*",
        "—É–º–Ω–æ–∂—å": "*",
        "—É–º–Ω–æ–∂–µ–Ω–Ω–æ–µ": "*",
        "—Ä–∞–∑–¥–µ–ª–∏—Ç—å": "/",
        "—Ä–∞–∑–¥–µ–ª–∏": "/",
        "–¥–µ–ª—ë–Ω–Ω–æ–µ": "/",
        "–¥–µ–ª–µ–Ω–Ω–æ–µ": "/",
        "–¥–µ–ª–∏—Ç—å": "/",
        "–Ω–∞": " ",
        "—Ä–∞–≤–Ω–æ": "",
        "–±—É–¥–µ—Ç": "",
        "—Å–∫–æ–ª—å–∫–æ": "",
        "–ø–æ—Å—á–∏—Ç–∞–π": "",
        "–≤—ã—á–∏—Å–ª–∏": "",
        "–∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä": "",
        "—Ä–∞—Å—Å—á–∏—Ç–∞–π": ""
    }

    for word, symbol in replacements.items():
        expression = expression.replace(word, symbol)

    # === –®–ê–ì 3: –ò–∑–≤–ª–µ–∫–∞–µ–º –≤—ã—Ä–∞–∂–µ–Ω–∏–µ ===
    # –£–±–∏—Ä–∞–µ–º –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–µ–ª—ã
    expression = re.sub(r'\s+', ' ', expression).strip()

    math_parts = re.findall(r'[\d+\-*/().\s]+', expression)

    if math_parts:
        result = ''.join(math_parts).strip()
        # –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã –º–µ–∂–¥—É —Ü–∏—Ñ—Ä–∞–º–∏ –∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞–º–∏
        result = re.sub(r'\s+', '', result)
        print(f"  üî¢ –†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ: '{user_input}' ‚Üí '{result}'")
        return {"expression": result}

    print(f"  ‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –∏–∑: '{user_input}'")
    return {}


def register_tool() -> Tool:
    """–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –≤–≤–æ–¥–∞"""
    return Tool(
        name="calculator",
        description="–í—ã–ø–æ–ª–Ω—è–µ—Ç –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è",
        usage_context="–ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç –ø–æ—Å—á–∏—Ç–∞—Ç—å –∏–ª–∏ –≤—ã—á–∏—Å–ª–∏—Ç—å",
        function=calculate,
        parameters={"expression": "–º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ"},
        keywords=[
            "–ø–æ—Å—á–∏—Ç–∞–π", "–≤—ã—á–∏—Å–ª–∏", "—Å–∫–æ–ª—å–∫–æ –±—É–¥–µ—Ç", "—Ä–∞—Å—Å—á–∏—Ç–∞–π",
            "–ø–ª—é—Å", "–º–∏–Ω—É—Å", "—É–º–Ω–æ–∂–∏—Ç—å", "—Ä–∞–∑–¥–µ–ª–∏—Ç—å", "—Ä–∞–≤–Ω–æ",
            "–∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä", "—Å—á–∏—Ç–∞–π", "—É–º–Ω–æ–∂—å", "—Ä–∞–∑–¥–µ–ª–∏"
        ],
        examples=[
            # –ë–∞–∑–æ–≤—ã–µ –ø—Ä–∏–º–µ—Ä—ã
            "—Å–∫–æ–ª—å–∫–æ –±—É–¥–µ—Ç 2 –ø–ª—é—Å 2?",
            "–ø–æ—Å—á–∏—Ç–∞–π 25 –ø–ª—é—Å 17",
            "–≤—ã—á–∏—Å–ª–∏ 100 –º–∏–Ω—É—Å 37",
            "—Å–∫–æ–ª—å–∫–æ –±—É–¥–µ—Ç 5 —É–º–Ω–æ–∂–∏—Ç—å –Ω–∞ 8?",
            "—Ä–∞–∑–¥–µ–ª–∏ 144 –Ω–∞ 12",

            # –° —Ç–µ–∫—Å—Ç–æ–≤—ã–º–∏ —á–∏—Å–ª–∞–º–∏ (–¥–ª—è –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –≤–≤–æ–¥–∞!)
            "—Å–∫–æ–ª—å–∫–æ –±—É–¥–µ—Ç –ø—è—Ç—å –ø–ª—é—Å –ø—è—Ç—å?",
            "–ø–æ—Å—á–∏—Ç–∞–π —Ç—Ä–∏ —É–º–Ω–æ–∂–∏—Ç—å –Ω–∞ —á–µ—Ç—ã—Ä–µ",
            "—Å–∫–æ–ª—å–∫–æ –±—É–¥–µ—Ç —Å–æ—Ä–æ–∫ —Ç—Ä–∏ –ø–ª—é—Å –¥–≤–∞?",
            "–≤—ã—á–∏—Å–ª–∏ –¥–≤–∞–¥—Ü–∞—Ç—å –ø—è—Ç—å –º–∏–Ω—É—Å –¥–µ—Å—è—Ç—å",
        ],
        parameter_extractor=extract_expression,
        categories = ["math", "calculation"]
    )
